worker_threads 2;
tcp_listen 5555;
admin_listen 127.0.0.1:9099;

http {
    upstream default {
        server 127.0.0.1:18081;
        server 127.0.0.1:18082;
        algorithm roundrobin;
    }

    upstream api_pool {
        server 127.0.0.1:18081 weight=5;
        server 127.0.0.1:18082 weight=1;
        algorithm weighted_roundrobin;
    }

    server {
        listen 18080;
        
        # --- TLS / SSL Configuration ---
        # ssl_certificate       /path/to/cert.pem;
        # ssl_certificate_key   /path/to/key.pem;

        # --- Rate Limiting ---
        rate_limit_per_ip  50;
        rate_limit_burst   100;
        # global_rate_limit  5000;

        # --- Web Application Firewall (WAF) ---
        # waf_enabled             true;
        # waf_auto_ban_threshold  10;
        # waf_auto_ban_duration   3600;

        # --- AI Predictive Routing ---
        # ai_algorithm              epsilon_greedy;
        # ai_epsilon                0.10;
        # ai_temperature            1.0;
        # ai_ucb_constant           1.414;
        # ai_thompson_threshold_ms  200.0;

        route /api {
            upstream api_pool;
            add_header X-Proxy-By "Phalanx";
            add_header X-Powered-By "Rust";
        }

        route /static {
            root static;
            add_header Cache-Control "public, max-age=31536000";
        }

        route / {
            upstream default;
            add_header Cache-Control "no-cache";

            # Example: rewrite old API path to new format (restart routing with 'last')
            # rewrite ^/v1/(.+)$ /api/$1 last;

            # Example: redirect legacy docs to new URL (301 Permanent)
            # rewrite ^/docs/(.+)$ https://docs.example.com/$1 permanent;

            # Example: internal path normalisation without redirect (break)
            # rewrite ^/home$ / break;
        }

        route /fcgi {
            fastcgi_pass 127.0.0.1:9000;
        }

        route /uwsgi {
            uwsgi_pass 127.0.0.1:3030;
        }
    }
}
